{% extends 'english/base.html' %}

{% block content %}
<div class="container my-5">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-light p-3 rounded-3">
            <li class="breadcrumb-item">
                <a href="{% url 'home' %}" class="text-decoration-none">
                    <i class="bi bi-house-door me-1"></i>–ì–ª–∞–≤–Ω–∞—è
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'course_detail' course.id %}" class="text-decoration-none">
                    {{ course.name }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ chapter.name }}</li>
        </ol>
    </nav>

    <div class="text-center mb-4">
        <h1 class="fw-bold text-primary mb-2">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞</h1>
        <h3 class="text-muted">{{ chapter.name }}</h3>
        <p class="text-secondary">–î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–ª–µ–¥—É—é—â–µ–π –≥–ª–∞–≤—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–±—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º 80%</p>
    </div>

    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-body p-4">
            <form method="post" id="controlForm">
                {% csrf_token %}
                {% for question in questions %}
                    <div class="card mb-3 border-0 shadow-sm rounded-3">
                        <div class="card-body p-3">
                            <h6 class="text-primary fw-bold mb-2">–í–æ–ø—Ä–æ—Å {{ forloop.counter }}</h6>
                            <div class="question-text">
                                {{ question.rendered_text|safe }}
                            </div>
                        </div>
                    </div>
                {% endfor %}

                <!-- –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ -->
                <div style="height: 80px;"></div>
            </form>

            <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
            <div id="stickyButtonContainer" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 90%; max-width: 400px;">
                <button type="submit" form="controlForm" class="btn btn-success w-100 py-3 rounded-pill shadow-lg">
                    <strong>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</strong>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-primary" id="resultModalLabel">–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 pt-2">
                <!-- –û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
                <div class="text-center mb-4">
                    <div class="display-4 fw-bold mb-2" id="scoreDisplay" style="color: #28a745;">0%</div>
                    <p class="lead mb-0" id="statusResult"></p>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="row g-3 mb-4">
                    <div class="col-4 text-center">
                        <div class="card border-0 bg-light rounded-3 p-3">
                            <div class="h3 mb-0 text-success" id="correctCount">0</div>
                            <small class="text-muted">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</small>
                        </div>
                    </div>
                    <div class="col-4 text-center">
                        <div class="card border-0 bg-light rounded-3 p-3">
                            <div class="h3 mb-0 text-danger" id="incorrectCount">0</div>
                            <small class="text-muted">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</small>
                        </div>
                    </div>
                    <div class="col-4 text-center">
                        <div class="card border-0 bg-light rounded-3 p-3">
                            <div class="h3 mb-0 text-primary" id="totalQuestions">0</div>
                            <small class="text-muted">–í—Å–µ–≥–æ</small>
                        </div>
                    </div>
                </div>

                <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è -->
                <div class="alert rounded-3 border-0" id="recommendationAlert">
                    <p class="mb-0" id="recommendation"></p>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <a href="{% url 'course_detail' course.id %}" class="btn btn-primary rounded-pill px-4">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ø–∏—Å–∫—É –≥–ª–∞–≤</a>
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('controlForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    let submitBtn = document.querySelector('#stickyButtonContainer button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>–û–±—Ä–∞–±–æ—Ç–∫–∞...';
    
    var formData = new FormData(this);
    fetch('', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        
        // –ó–∞–º–µ–Ω—è–µ–º input-–ø–æ–ª—è –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–∫–∞–∫ –≤ topic.html)
        Object.keys(data.results).forEach(qid => {
            let userAnswers = data.user_answers[qid].answer || {};
            let correctAnswers = data.correct_answers[qid] || {};

            Object.keys(userAnswers).forEach(blankKey => {
                let userAnswer = userAnswers[blankKey].trim();
                let correctAnswer = correctAnswers[blankKey];
                
                let correctList = Array.isArray(correctAnswer) ? correctAnswer : [correctAnswer];
                let correctText = correctList.join(' / ');

                let isBlankCorrect = false;
                if (Array.isArray(correctAnswer)) {
                    isBlankCorrect = correctAnswer.some(ans => ans.toLowerCase().trim() === userAnswer.toLowerCase());
                } else {
                    isBlankCorrect = correctAnswer.toLowerCase().trim() === userAnswer.toLowerCase();
                }

                let input = document.querySelector(`input[name="q_${qid}_${blankKey}"]`);
                
                if (input) {
                    let replacement;
                    
                    if (isBlankCorrect) {
                        replacement = document.createElement('span');
                        replacement.style.color = 'green';
                        replacement.style.fontWeight = 'bold';
                        replacement.innerHTML = `${userAnswer} ‚úÖ`;
                    } else {
                        replacement = document.createElement('span');
                        replacement.innerHTML = `<s style="color: red; font-weight: bold;">${userAnswer}</s> <span style="color: green; font-weight: bold;">${correctText} ‚úÖ</span>`;
                    }
                    
                    input.replaceWith(replacement);
                }
            });
        });
        
        // –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        const totalQuestions = Object.keys(data.results).length;
        const correctCount = Object.values(data.results).filter(r => r).length;
        const incorrectCount = totalQuestions - correctCount;
        const score = data.score;
        
        document.getElementById('scoreDisplay').textContent = score.toFixed(0) + '%';
        document.getElementById('correctCount').textContent = correctCount;
        document.getElementById('incorrectCount').textContent = incorrectCount;
        document.getElementById('totalQuestions').textContent = totalQuestions;

        // –°—Ç–∞—Ç—É—Å –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        const recommendationAlert = document.getElementById('recommendationAlert');
        if (score >= 80) {
            document.getElementById('scoreDisplay').style.color = '#28a745';
            document.getElementById('statusResult').innerHTML = 'üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É!';
            document.getElementById('recommendation').textContent = '–°–ª–µ–¥—É—é—â–∞—è –≥–ª–∞–≤–∞ –æ—Ç–∫—Ä—ã—Ç–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ–±—É—á–µ–Ω–∏–µ!';
            recommendationAlert.className = 'alert rounded-3 border-0 alert-success';
        } else {
            document.getElementById('scoreDisplay').style.color = '#dc3545';
            document.getElementById('statusResult').innerHTML = 'üòî –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –Ω–µ –ø—Ä–æ—à–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É.';
            document.getElementById('recommendation').textContent = '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞. –î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–ª–µ–¥—É—é—â–µ–π –≥–ª–∞–≤—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–±—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º 80%.';
            recommendationAlert.className = 'alert rounded-3 border-0 alert-warning';
        }

        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        var myModal = new bootstrap.Modal(document.getElementById('resultModal'));
        myModal.show();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
        submitBtn.textContent = '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω ‚úì';
        submitBtn.classList.remove('btn-success');
        submitBtn.classList.add('btn-secondary');
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<strong>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</strong>';
    });
});
</script>

<style>
    @media (max-width: 576px) {
        #stickyButtonContainer {
            width: 95%;
        }
    }
</style>
{% endblock content %}