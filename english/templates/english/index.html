{% extends 'english/base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <!-- Hero Section -->
  <section id="home" class="py-5">
    <div class="row align-items-center g-4">
      <div class="col-lg-6">
        <div class="hero-content">
          <span class="badge bg-success-subtle text-success mb-3 px-3 py-2 rounded-pill">
            üéì –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
          </span>
          <h1 class="display-4 fw-bold mb-4 text-dark lh-base">
            –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ IELTS –∏ –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–º —Ç–µ—Å—Ç–∞–º –í–£–ó–æ–≤
          </h1>
          <p class="lead text-secondary mb-3">
            –ú–µ–Ω—è –∑–æ–≤—É—Ç <span class="fw-bold text-primary">–ë–∞–π—Ä–∞–º</span>, —è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ —Å –æ–ø—ã—Ç–æ–º –±–æ–ª–µ–µ 8 –ª–µ—Ç.
          </p>
          <div class="bg-light rounded-3 p-3 mb-4">
            <p class="mb-2 text-muted">
              <i class="bi bi-check-circle-fill text-success me-2"></i>
              –ú–æ–∏ –≤—ã–ø—É—Å–∫–Ω–∏–∫–∏ —É—á–∞—Ç—Å—è –≤ <strong>–ú–ì–£</strong>, <strong>–ù–ò–£ –í–®–≠</strong>, <strong>–ú–§–¢–ò</strong>
            </p>
            <p class="mb-0 text-muted">
              <i class="bi bi-check-circle-fill text-success me-2"></i>
              –ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            </p>
          </div>
          <a href="#tariff" class="btn btn-success btn-lg px-5 py-3 rounded-pill shadow-sm">
            <i class="bi bi-rocket-takeoff me-2"></i>–í—ã–±—Ä–∞—Ç—å –∫—É—Ä—Å
          </a>
        </div>
      </div>
      <div class="col-lg-6 text-center">
        <img
          src="https://cdn.cpdonline.co.uk/wp-content/uploads/2023/02/24155222/Teacher-Teaching-Online.jpg"
          class="img-fluid rounded-4 shadow-lg"
          alt="–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å"
          style="max-height: 500px; object-fit: cover;"
        />
      </div>
    </div>
  </section>

  <!-- –ö–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç –æ–±—É—á–µ–Ω–∏–µ -->
  <section class="py-5 bg-light rounded-4 my-5">
    <div class="text-center mb-5">
      <h2 class="fw-bold mb-3 text-dark">
        <i class="bi bi-lightbulb text-warning me-2"></i>
        –ö–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç –æ–±—É—á–µ–Ω–∏–µ
      </h2>
      <p class="text-muted">–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∫–∞–∂–¥–æ–º—É —É—á–µ–Ω–∏–∫—É</p>
    </div>

    <div class="row g-4 px-3">
      <div class="col-md-4">
        <div class="card h-100 border-0 shadow-sm hover-lift" style="transition: transform 0.3s;">
          <div class="card-img-wrapper position-relative overflow-hidden rounded-top-3">
            <img
              src="https://antaltalent.ru/wp-content/uploads/2023/01/tpk_prev.jpg"
              class="card-img-top"
              alt="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
              style="height: 200px; object-fit: cover;"
            />
            <div class="position-absolute top-0 start-0 m-3">
              <span class="badge bg-primary rounded-pill px-3 py-2">–®–∞–≥ 1</span>
            </div>
          </div>
          <div class="card-body p-4">
            <h5 class="card-title fw-bold mb-3">
              <i class="bi bi-clipboard-check text-primary me-2"></i>
              –ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            </h5>
            <p class="card-text text-muted">
              –û–ø—Ä–µ–¥–µ–ª–∏–º –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –∑–Ω–∞–Ω–∏–π, —á—Ç–æ–±—ã –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è.
            </p>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card h-100 border-0 shadow-sm hover-lift" style="transition: transform 0.3s;">
          <div class="card-img-wrapper position-relative overflow-hidden rounded-top-3">
            <img
              src="https://www.unicraft.org/wp-content/uploads/2021/02/cropped-colleagues-generating-business-ideas_1098-19137.jpg"
              class="card-img-top"
              alt="–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å"
              style="height: 200px; object-fit: cover;"
            />
            <div class="position-absolute top-0 start-0 m-3">
              <span class="badge bg-success rounded-pill px-3 py-2">–®–∞–≥ 2</span>
            </div>
          </div>
          <div class="card-body p-4">
            <h5 class="card-title fw-bold mb-3">
              <i class="bi bi-chat-dots text-success me-2"></i>
              –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
            </h5>
            <p class="card-text text-muted">
              –ü–æ–ª—É—á–∞–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –±—ã—Å—Ç—Ä–µ–µ.
            </p>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card h-100 border-0 shadow-sm hover-lift" style="transition: transform 0.3s;">
          <div class="card-img-wrapper position-relative overflow-hidden rounded-top-3">
            <img
              src="https://shablon.klev.club/uploads/posts/2024-09/shablon-klev-club-zl8b-p-shabloni-kalendar-na-mesyats-bez-dat-1.jpg"
              class="card-img-top"
              alt="–ì—Ä–∞—Ñ–∏–∫ –∑–∞–Ω—è—Ç–∏–π"
              style="height: 200px; object-fit: cover;"
            />
            <div class="position-absolute top-0 start-0 m-3">
              <span class="badge bg-info rounded-pill px-3 py-2">–®–∞–≥ 3</span>
            </div>
          </div>
          <div class="card-body p-4">
            <h5 class="card-title fw-bold mb-3">
              <i class="bi bi-calendar-check text-info me-2"></i>
              –£–¥–æ–±–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
            </h5>
            <p class="card-text text-muted">
              –í—ã–±–∏—Ä–∞–π—Ç–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–∏–π ‚Äî –æ—Ñ–ª–∞–π–Ω –∏–ª–∏ –æ–Ω–ª–∞–π–Ω.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- –¢–∞—Ä–∏—Ñ—ã -->
  <section id="tariffs" class="py-5">
    <div class="text-center mb-5">
      <h2 class="fw-bold mb-3 text-dark">
        <i class="bi bi-star-fill text-warning me-2"></i>
        –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –∫—É—Ä—Å
      </h2>
      <p class="text-muted">–ì–∏–±–∫–∏–µ —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è –ª—é–±—ã—Ö —Ü–µ–ª–µ–π –∏ —É—Ä–æ–≤–Ω–µ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏</p>
    </div>

    <div class="row g-4">
      {% for course in courses %}
      <div class="col-lg-6">
        <div class="card h-100 border-0 shadow-lg rounded-4 overflow-hidden hover-lift" style="transition: all 0.3s;">
          <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫—É—Ä—Å–∞ -->
          <div class="card-header bg-gradient text-white p-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <h4 class="card-title text-center fw-bold mb-2">
              <i class="bi bi-book me-2"></i>{{ course.name }}
            </h4>
            <p class="text-center mb-0 opacity-75">
              {{ course.description|truncatewords:15 }}
            </p>
          </div>

          <div class="card-body p-4">
            <!-- –¢–∞—Ä–∏—Ñ—ã –∫—É—Ä—Å–∞ -->
            {% if course.tariffs.all %}
              <div class="tariffs-list">
                {% for tariff in course.tariffs.all %}
                <div class="tariff-item border rounded-3 p-3 mb-3 {% if tariff.is_free %}bg-success-subtle{% else %}bg-light{% endif %}" style="transition: all 0.2s;">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="fw-bold mb-1">
                        {% if tariff.is_free %}
                          <i class="bi bi-gift text-success me-1"></i>
                        {% else %}
                          <i class="bi bi-tag text-primary me-1"></i>
                        {% endif %}
                        {{ tariff.name }}
                      </h6>
                      <small class="text-muted">{{ tariff.description|truncatewords:8 }}</small>
                    </div>
                    <div class="text-end">
                      {% if tariff.is_free %}
                        <span class="badge bg-success px-3 py-2 mb-2">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                      {% else %}
                        <div class="fw-bold text-success fs-5 mb-2">{{ tariff.price|floatformat:0 }} —Å—É–º</div>
                      {% endif %}
                      <a href="{% url 'buy_tariff' tariff.id %}" class="btn btn-sm {% if tariff.is_free %}btn-outline-success{% else %}btn-outline-primary{% endif %} rounded-pill px-3">
                        {% if tariff.is_free %}
                          <i class="bi bi-play-circle me-1"></i>–ù–∞—á–∞—Ç—å
                        {% else %}
                          <i class="bi bi-cart me-1"></i>–ö—É–ø–∏—Ç—å
                        {% endif %}
                      </a>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted text-center">–¢–∞—Ä–∏—Ñ—ã —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è</p>
            {% endif %}
          </div>

          <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ä–æ–±–Ω–µ–µ -->
          <div class="card-footer bg-transparent border-0 p-4 pt-0">
            <a href="{% url 'course_detail' course.id %}" class="btn btn-primary w-100 py-3 rounded-pill">
              <i class="bi bi-info-circle me-2"></i>–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –∫—É—Ä—Å–µ
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- –û—Ç–∑—ã–≤—ã -->
  <section class="py-5 bg-light rounded-4 my-5" id="comments">
    <div class="text-center mb-5">
      <h2 class="fw-bold text-dark mb-3">
        <i class="bi bi-chat-heart text-danger me-2"></i>
        –û—Ç–∑—ã–≤—ã —É—á–µ–Ω–∏–∫–æ–≤
      </h2>
      <p class="text-muted">–†–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –æ—Ç –Ω–∞—à–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</p>
    </div>

    {% if comments %}
    <div id="carouselComments" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-inner px-5">
        {% for comment in comments %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}" data-bs-interval="5000">
          <div class="text-center">
            <!-- –ê–≤–∞—Ç–∞—Ä -->
            <div class="mb-4">
              {% if comment.user.avatar %}
              <img
                src="{{ comment.user.avatar.url }}"
                class="rounded-circle shadow-lg border border-4 border-white"
                alt="–ê–≤–∞—Ç–∞—Ä {{ comment.user.first_name }}"
                width="120"
                height="120"
                style="object-fit: cover;"
                loading="lazy"
              />
              {% else %}
              <img
                src="https://ui-avatars.com/api/?name={{ comment.user.first_name }}+{{ comment.user.last_name }}&size=120&background=667eea&color=fff&bold=true"
                class="rounded-circle shadow-lg border border-4 border-white"
                alt="–ê–≤–∞—Ç–∞—Ä {{ comment.user.first_name }}"
                width="120"
                height="120"
                loading="lazy"
              />
              {% endif %}
            </div>

            <!-- –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ -->
            <div class="mx-auto" style="max-width: 600px;">
              <i class="bi bi-quote text-primary fs-1 opacity-25"></i>
              <p class="lead text-dark mb-3">{{ comment.text }}</p>
              <h5 class="fw-bold text-dark">{{ comment.user.first_name }} {{ comment.user.last_name }}</h5>
              <div class="text-warning">
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselComments" data-bs-slide="prev">
        <div class="bg-white rounded-circle p-3 shadow">
          <i class="bi bi-chevron-left text-dark fs-4"></i>
        </div>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselComments" data-bs-slide="next">
        <div class="bg-white rounded-circle p-3 shadow">
          <i class="bi bi-chevron-right text-dark fs-4"></i>
        </div>
        <span class="visually-hidden">Next</span>
      </button>

      <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
      <div class="carousel-indicators position-static mt-4">
        {% for comment in comments %}
        <button
          type="button"
          data-bs-target="#carouselComments"
          data-bs-slide-to="{{ forloop.counter0 }}"
          class="{% if forloop.first %}active{% endif %}"
          style="width: 10px; height: 10px; border-radius: 50%;"
        ></button>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <div class="text-center">
      <div class="bg-white rounded-4 p-5 shadow-sm mx-auto" style="max-width: 500px;">
        <i class="bi bi-chat-dots text-muted fs-1 mb-3"></i>
        <p class="text-muted mb-3">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
        {% if not user.is_authenticated %}
        <a href="{% url 'login' %}" class="btn btn-primary rounded-pill px-4">
          –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
        </a>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
    {% if user.is_authenticated %}
    <div class="container mt-5" style="max-width: 700px;">
      <div class="card shadow border-0 rounded-4">
        <div class="card-body p-4">
          <h5 class="card-title fw-bold mb-4">
            <i class="bi bi-pencil-square text-primary me-2"></i>
            –û—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π –æ—Ç–∑—ã–≤
          </h5>
          <form id="commentForm">
            {% csrf_token %}
            {{ comment_form.as_p }}
            <button type="submit" class="btn btn-success w-100 py-3 rounded-pill mt-3">
              <i class="bi bi-send me-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
            </button>
          </form>
          <div id="commentMessage" class="mt-3"></div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="text-center mt-5">
      <a href="{% url 'login' %}" class="btn btn-primary btn-lg rounded-pill px-5">
        <i class="bi bi-box-arrow-in-right me-2"></i>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
      </a>
    </div>
    {% endif %}
  </section>
</div>

<!-- AJAX –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
{% if user.is_authenticated %}
<script>
  document.getElementById("commentForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = e.target;
    const data = new FormData(form);
    const messageDiv = document.getElementById("commentMessage");

    try {
      const response = await fetch("{% url 'home' %}", {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: data,
      });
      const result = await response.json();

      if (result.success && result.user && result.text) {
        messageDiv.innerHTML = '<div class="alert alert-success rounded-pill"><i class="bi bi-check-circle me-2"></i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω!</div>';

        const carouselInner = document.querySelector("#carouselComments .carousel-inner");
        const newItem = document.createElement("div");
        newItem.className = "carousel-item";

        let avatarHTML = result.avatar_url
          ? `<img src="${result.avatar_url}" class="rounded-circle shadow-lg border border-4 border-white" width="120" height="120" style="object-fit: cover;" alt="${result.user}">`
          : `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(result.user)}&size=120&background=667eea&color=fff&bold=true" class="rounded-circle shadow-lg border border-4 border-white" width="120" height="120" alt="${result.user}">`;

        newItem.innerHTML = `
          <div class="text-center">
            <div class="mb-4">${avatarHTML}</div>
            <div class="mx-auto" style="max-width: 600px;">
              <i class="bi bi-quote text-primary fs-1 opacity-25"></i>
              <p class="lead text-dark mb-3">${result.text}</p>
              <h5 class="fw-bold text-dark">${result.user}</h5>
              <div class="text-warning">
                <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
              </div>
            </div>
          </div>
        `;
        carouselInner.appendChild(newItem);

        form.reset();
        setTimeout(() => { messageDiv.innerHTML = ""; }, 3000);
      } else {
        messageDiv.innerHTML = `<div class="alert alert-danger rounded-pill">${result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏"}</div>`;
      }
    } catch (error) {
      messageDiv.innerHTML = '<div class="alert alert-danger rounded-pill">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
      setTimeout(() => { messageDiv.innerHTML = ""; }, 3000);
    }
  });
</script>
{% endif %}

<style>
  .hover-lift:hover {
    transform: translateY(-10px);
    box-shadow: 0 1rem 3rem rgba(0,0,0,.175) !important;
  }
  
  .tariff-item:hover {
    transform: scale(1.02);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,.1);
  }
</style>

{% endblock content %}