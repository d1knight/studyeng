{% extends "english/base.html" %}
{% block content %}

<div class="container my-5">
  <div class="card shadow-sm border-0 rounded-4 mx-auto" style="max-width: 700px">
    <div class="card-body p-4">
      <h2 class="fw-bold text-center mb-4 text-dark">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>

      <!-- üîπ –ê–≤–∞—Ç–∞—Ä –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
      <div class="text-center mb-4">
        <div id="avatar-preview">
          {% if user.avatar %}
          <!-- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∑–∏–ª –∞–≤–∞—Ç–∞—Ä -->
          <img src="{{ user.avatar.url }}" alt="Avatar" class="rounded-circle shadow-sm"
               style="width: 100px; height: 100px; object-fit: cover;" id="current-avatar" />
          {% else %}
          <!-- –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –∞–≤–∞—Ç–∞—Ä -->
          <img src="https://ui-avatars.com/api/?name={{ user.first_name }}+{{ user.last_name }}&size=100&background=0D8ABC&color=fff&bold=true" 
               alt="Avatar" class="rounded-circle shadow-sm"
               style="width: 100px; height: 100px; object-fit: cover;" id="current-avatar" />
          {% endif %}
        </div>

        <h5 class="mt-3 mb-0 fw-semibold">{{ user.first_name }} {{ user.last_name }}</h5>
        {% if user.email %}
        <p class="text-muted mb-2">{{ user.email }}</p>
        {% endif %}
        <p class="text-muted"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ user.phone_number }}</p>

        <!-- üîπ –§–æ—Ä–º–∞ —Å–º–µ–Ω—ã –∞–≤–∞—Ç–∞—Ä–∞ -->
        <form method="post" enctype="multipart/form-data" class="mt-3" id="avatar-form">
          {% csrf_token %}
          <div class="input-group" style="max-width: 300px; margin: 0 auto;">
            <input type="file" name="avatar" class="form-control form-control-sm" 
                   accept="image/*" id="avatar-input">
            <button type="submit" class="btn btn-outline-primary btn-sm">–ò–∑–º–µ–Ω–∏—Ç—å</button>
          </div>
          <small class="text-muted d-block mt-1">–§–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF (–º–∞–∫—Å. 5 –ú–ë)</small>
        </form>
      </div>

      <hr class="my-4" />

      <!-- üîπ –ú–æ–∏ –∫—É—Ä—Å—ã -->
      <h4 class="fw-semibold mb-3">–ú–æ–∏ –∫—É—Ä—Å—ã</h4>
      {% if courses_data %}
      <div class="list-group mb-4">
        {% for course_data in courses_data %}
        <div class="list-group-item mb-2 d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1 fw-bold">{{ course_data.course.name }}</h6>
            <p class="mb-1 text-muted">{{ course_data.course.description|truncatewords:20 }}</p>
            <small class="text-muted">
              –¢–∞—Ä–∏—Ñ: {{ course_data.tariff.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }} |
              –ü—Ä–æ–≥—Ä–µ—Å—Å: {{ course_data.progress }}%
            </small>
          </div>
          <a href="{% url 'course_detail' course_data.course.id %}" class="btn btn-sm btn-primary">
            –ü–µ—Ä–µ–π—Ç–∏ –∫ –∫—É—Ä—Å—É
          </a>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-muted">
        –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫—É—Ä—Å–æ–≤. <a href="/#home">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</a>
      </p>
      {% endif %}

      <hr class="my-4" />

      <!-- üîπ –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
      <h4 class="fw-semibold mb-3">–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
      <form method="post" class="mb-4">
        {% csrf_token %}
        {{ comment_form.as_p }}
        <button type="submit" name="add_comment" class="btn btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>

      <!-- üîπ –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
      <h5 class="mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</h5>
      {% if comments %}
      <div class="list-group">
        {% for comment in comments %}
        <div class="list-group-item mb-2 d-flex justify-content-between align-items-start" id="comment-{{ comment.id }}">
          <div class="flex-grow-1">
            <strong>{{ comment.user.first_name }} {{ comment.user.last_name }}:</strong>
            <p class="mb-1 comment-text">{{ comment.text }}</p>
            <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
          </div>

          {% if comment.user == user %}
          <div class="ms-3 d-flex flex-column gap-1">
            <button class="btn btn-sm btn-warning edit-btn" data-id="{{ comment.id }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button type="button" class="btn btn-sm btn-danger delete-btn"
                    data-bs-toggle="modal" data-bs-target="#deleteModal{{ comment.id }}">
              –£–¥–∞–ª–∏—Ç—å
            </button>

            <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
            <div class="modal fade" id="deleteModal{{ comment.id }}" tabindex="-1"
                 aria-labelledby="deleteModalLabel{{ comment.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel{{ comment.id }}">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?</div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-danger confirm-delete" data-id="{{ comment.id }}">–£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    // üîπ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
    const avatarInput = document.getElementById("avatar-input");
    if (avatarInput) {
      avatarInput.addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file) {
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (5 –ú–ë)
          if (file.size > 5 * 1024 * 1024) {
            alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º: 5 –ú–ë");
            e.target.value = "";
            return;
          }

          // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
          const reader = new FileReader();
          reader.onload = function(event) {
            const currentAvatar = document.getElementById("current-avatar");
            currentAvatar.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // üîπ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    document.addEventListener("click", function (e) {
      if (e.target && e.target.classList.contains("edit-btn")) {
        const btn = e.target;
        const commentId = btn.dataset.id;
        const commentDiv = document.getElementById("comment-" + commentId);
        const textEl = commentDiv.querySelector(".comment-text");
        const originalText = textEl.textContent;

        if (commentDiv.querySelector("input")) return;

        const input = document.createElement("input");
        input.type = "text";
        input.value = originalText;
        input.classList.add("form-control", "mb-2");

        const saveBtn = document.createElement("button");
        saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        saveBtn.classList.add("btn", "btn-primary", "btn-sm", "mb-1");

        const cancelBtn = document.createElement("button");
        cancelBtn.textContent = "–û—Ç–º–µ–Ω–∞";
        cancelBtn.classList.add("btn", "btn-secondary", "btn-sm", "mb-1", "ms-1");

        textEl.style.display = "none";
        btn.style.display = "none";

        const deleteBtn = commentDiv.querySelector(".delete-btn");
        if (deleteBtn) deleteBtn.style.display = "none";

        commentDiv.querySelector(".flex-grow-1").appendChild(input);
        commentDiv.querySelector(".flex-grow-1").appendChild(saveBtn);
        commentDiv.querySelector(".flex-grow-1").appendChild(cancelBtn);

        saveBtn.addEventListener("click", function () {
          const newText = input.value;

          fetch("", {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `edit_comment=1&comment_id=${commentId}&text=${encodeURIComponent(newText)}&csrfmiddlewaretoken=${csrfToken}`,
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                textEl.textContent = data.comment.text;
                textEl.style.display = "";
                input.remove();
                saveBtn.remove();
                cancelBtn.remove();
                btn.style.display = "";
                if (deleteBtn) deleteBtn.style.display = "";
              }
            });
        });

        cancelBtn.addEventListener("click", function () {
          textEl.style.display = "";
          input.remove();
          saveBtn.remove();
          cancelBtn.remove();
          btn.style.display = "";
          if (deleteBtn) deleteBtn.style.display = "";
        });
      }

      if (e.target && e.target.classList.contains("confirm-delete")) {
        const commentId = e.target.dataset.id;
        const commentDiv = document.getElementById("comment-" + commentId);
        const modalEl = document.getElementById("deleteModal" + commentId);
        const modalInstance = bootstrap.Modal.getInstance(modalEl);

        fetch("", {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `delete_comment=1&comment_id=${commentId}&csrfmiddlewaretoken=${csrfToken}`,
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              if (modalInstance) modalInstance.hide();
              commentDiv.remove();
            }
          });
      }
    });
  });
</script>

{% endblock content %}