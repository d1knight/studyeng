{% extends 'english/base.html' %}
{% block content %}
<div class="container mt-4">
  <h1 class="mb-4 text-center">{{ topic.name }}</h1>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav>
    <div class="nav nav-tabs" id="nav-tab" role="tablist">
      <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab">
        üìò –¢–µ–æ—Ä–∏—è
      </button>
      <button class="nav-link" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-profile" type="button" role="tab">
        ‚úçÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
      </button>
    </div>
  </nav>

  <div class="tab-content mt-3" id="nav-tabContent">
    <!-- –¢–µ–æ—Ä–∏—è -->
    <div class="tab-pane fade show active" id="nav-home" role="tabpanel">
      <div class="card shadow-sm">
        <div class="card-body">
          <p class="fs-5">{{ topic.content|safe }}</p>
        </div>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
    <div class="tab-pane fade" id="nav-profile" role="tabpanel">
      <form id="exerciseForm" class="mt-2">
        {% csrf_token %}
        {% for exercise in exercises %}
        <div class="card shadow-sm mb-2 exercise-block">
          <div class="card-header bg-primary text-white py-1 px-2">
            –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ {{ forloop.counter }}
          </div>
          <div class="card-body py-2 px-2">
            {% for q in exercise.questions.all %}
            <div class="mb-1">
              <label class="form-label small mb-0 text-muted">
                –í–æ–ø—Ä–æ—Å {{ forloop.counter }}
              </label>
              <div class="d-inline-block">
                {{ q.render_with_inputs|safe }}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
        <button type="submit" class="btn btn-success btn-sm w-100 mt-2">
          –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã
        </button>
      </form>

      <!-- Modal -->
      <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-success text-white py-2">
              <h5 class="modal-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3" id="resultsBody"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById("exerciseForm").addEventListener("submit", function (e) {
    e.preventDefault();

    let exercises = document.querySelectorAll(".exercise-block");
    let totalInputs = 0;
    let correctCount = 0;
    let resultsHtml = "";

    exercises.forEach((exerciseBlock, index) => {
      let inputs = exerciseBlock.querySelectorAll(".answer-field");
      if (inputs.length === 0) return;

      resultsHtml += `<div class="mb-2"><h6>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ${index + 1}</h6><ul class="list-group list-group-flush">`;

      inputs.forEach((input) => {
        totalInputs++;
        let correctAnswers = input.dataset.correct
          .split("|")
          .map((a) => a.trim().toLowerCase());
        let userAnswer = input.value.trim();

        if (correctAnswers.includes(userAnswer.toLowerCase())) {
          correctCount++;
          resultsHtml += `<li class="list-group-item list-group-item-success py-1">
              ‚úÖ <b>${userAnswer || "‚Äî"}</b>
            </li>`;
        } else {
          resultsHtml += `<li class="list-group-item list-group-item-danger py-1">
              ‚ùå <s>${userAnswer || "‚Äî"}</s> ‚Üí ‚úÖ <b>${correctAnswers.join(" / ")}</b>
            </li>`;
        }
      });

      resultsHtml += "</ul></div>";
    });

    resultsHtml =
      `<p class="mb-2">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <b>${correctCount}</b> –∏–∑ <b>${totalInputs}</b></p>` +
      resultsHtml;

    document.getElementById("resultsBody").innerHTML = resultsHtml;

    let modal = new bootstrap.Modal(document.getElementById("resultModal"));
    modal.show();
  });
</script>
{% endblock %}
