{% extends 'english/base.html' %}
{% block content %}
<div class="container mt-4">
  <h1 class="mb-4 text-center">{{ topic.name }}</h1>

  <ul class="nav nav-tabs">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#theory">üìò –¢–µ–æ—Ä–∏—è</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exercises">‚úçÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="theory">
      <div class="card shadow-sm">
        <div class="card-body">
          {{ topic.content|safe }}
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="exercises">
      <form id="exerciseForm" method="post">
        {% csrf_token %}
        {% for exercise in exercises %}
        <div class="card shadow-sm mb-2">
          <div class="card-header bg-primary text-white">
            –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ {{ forloop.counter }}
          </div>
          <div class="card-body">
            <p>{{ exercise.instruction }} <small class="text-muted">(–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É —Å–ª–æ–≤–∞ –≤ –ø—Ä–æ–ø—É—Å–∫–∏)</small></p>
            {% for q in exercise.questions.all %}
              <div class="mb-2">
                {{ q.render_with_inputs|safe }}
              </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
        <button type="submit" class="btn btn-success w-100 mt-2">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      </form>

      <!-- Modal -->
      <div class="modal fade" id="resultModal">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h5>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultsBody"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById("exerciseForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  let formData = new FormData(this);

  let response = await fetch("", {
    method: "POST",
    body: formData,
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });
  let data = await response.json();

  let resultsHtml = "";
  let correctCount = 0;
  let total = Object.keys(data.results).length;

  Object.keys(data.results).forEach((qid, idx) => {
    let isCorrect = data.results[qid];
    let userAnswer = Object.values(data.user_answers[qid] || {}).join(", ") || "‚Äî";
    let correctAnswer = Object.values(data.correct_answers[qid] || {}).join(", ");

    if (isCorrect) {
      correctCount++;
      resultsHtml += `
        <div class="alert alert-success p-2 mb-2">
          <b>–í–æ–ø—Ä–æ—Å ${idx+1}:</b> ‚úÖ –í–∞—à –æ—Ç–≤–µ—Ç: <u>${userAnswer}</u>
        </div>`;
    } else {
      resultsHtml += `
        <div class="alert alert-danger p-2 mb-2">
          <b>–í–æ–ø—Ä–æ—Å ${idx+1}:</b> ‚ùå –í–∞—à –æ—Ç–≤–µ—Ç: <s>${userAnswer}</s> ‚Üí –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π: <u>${correctAnswer}</u>
        </div>`;
    }
  });

  resultsHtml = `<p><b>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${correctCount} –∏–∑ ${total}</b></p>` + resultsHtml;
  document.getElementById("resultsBody").innerHTML = resultsHtml;

  new bootstrap.Modal(document.getElementById("resultModal")).show();
});
</script>
{% endblock %}